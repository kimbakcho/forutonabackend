<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wing.forutona.FcubeDao.FcubequestsuccessExtender1Mapper">
  <resultMap id="BaseResultMap" type="com.wing.forutona.FcubeDto.FcubequestsuccessExtender1">

    <id column="reqno" jdbcType="INTEGER" property="reqno" />
    <result column="Cubeuuid" jdbcType="VARCHAR" property="cubeuuid" />
    <result column="Uid" jdbcType="VARCHAR" property="uid" />
    <result column="FromUid" jdbcType="VARCHAR" property="fromuid" />
    <result column="ReadingCheck" jdbcType="INTEGER" property="readingcheck" />
    <result column="ScuessCheck" jdbcType="INTEGER" property="scuesscheck" />
    <result column="ReqTime" jdbcType="TIMESTAMP" property="reqtime" />
    <result column="JudgmentTime" jdbcType="TIMESTAMP" property="judgmenttime" />
    <result column="ToPlayerComment" jdbcType="VARCHAR" property="toplayercomment" />
    <result column="Content" jdbcType="LONGVARCHAR" property="content" />
    <result column="toMakerComment" jdbcType="VARCHAR" property="tomakercomment" />
    <result column="StarPoint" jdbcType="DOUBLE" property="starpoint" />
    <result column="NickName" jdbcType="VARCHAR" property="nickname" />
    <result column="ProfilePicktureUrl" jdbcType="VARCHAR" property="profilepicktureurl" />
    <result column="UserLevel" jdbcType="DOUBLE" property="userlevel" />
    <result column="ReadUid" jdbcType="VARCHAR" property="readuid" />
    <result column="Confirm" jdbcType="INTEGER" property="confirm" />
  </resultMap>
<!--  ReadingCheck == null 은 FcubeQuestResultView 에서 사용한다-->
  <select id="getQuestReqList" parameterType="com.wing.forutona.FcubeDto.FcubequestsuccessExtender1" resultMap="BaseResultMap" >
    SELECT  A.reqno, A.Cubeuuid, A.Uid, A.FromUid, A.ContentType, A.ReadingCheck, A.ScuessCheck, A.ReqTime,
    A.JudgmentTime, A.Content,A.ToPlayerComment,A.toMakerComment,A.StarPoint,B.NickName,B.ProfilePicktureUrl,B.UserLevel FROM FcubeQuestSuccess A LEFT JOIN UserInfo B ON A.FromUid = B.Uid
    WHERE A.Cubeuuid = #{cubeuuid} AND A.Uid = #{uid}
    <if test="readingcheck != null">
      AND A.ReadingCheck = #{readingcheck}
    </if>
    ORDER BY ScuessCheck desc ,ReqTime asc
  </select>

  <select id="getQuestSucessList" parameterType="com.wing.forutona.FcubeDto.FcubequestsuccessExtender1" resultMap="BaseResultMap" >
    SELECT  A.reqno, A.Cubeuuid, A.Uid, A.FromUid, A.ContentType, A.ReadingCheck, A.ScuessCheck, A.ReqTime,
    A.JudgmentTime, A.Content,A.ToPlayerComment,A.toMakerComment,A.StarPoint,B.NickName,B.ProfilePicktureUrl,B.UserLevel FROM FcubeQuestSuccess A LEFT JOIN UserInfo B ON A.FromUid = B.Uid
    WHERE A.Cubeuuid = #{cubeuuid} AND A.Uid = #{uid} AND A.ScuessCheck = 1 ORDER BY ReqTime asc FOR UPDATE
  </select>

  <update id="updateAllReadingCheck" parameterType="com.wing.forutona.FcubeDto.FcubequestsuccessExtender1">
    UPDATE  FcubeQuestSuccess
        set ReadingCheck = #{readingcheck},
    WHERE Cubeuuid = #{cubeuuid}
  </update>

  <update id="updateQuestReq" parameterType="com.wing.forutona.FcubeDto.FcubequestsuccessExtender1">
    UPDATE  FcubeQuestSuccess
    set ReadingCheck = #{readingcheck},
    ScuessCheck = #{scuesscheck},
    JudgmentTime = #{judgmenttime}
    WHERE Cubeuuid = #{cubeuuid} AND FromUid = #{fromuid}
  </update>

  <update id="updateQuesttoplayercomment" parameterType="com.wing.forutona.FcubeDto.FcubequestsuccessExtender1">
    UPDATE  FcubeQuestSuccess
    set ToPlayerComment = #{toplayercomment}
    WHERE Cubeuuid = #{cubeuuid} AND FromUid = #{fromuid}
  </update>

<!--  Player가 퀘스트 완료/실패 확인하지 않는  메세지 확인 하는 부분-->
  <select id="getPlayerQuestSuccessList" parameterType="com.wing.forutona.FcubeDto.FcubequestsuccessExtender1" resultMap="BaseResultMap">
    SELECT A.reqno, A.Cubeuuid, A.Uid, A.FromUid, A.ContentType, A.ReadingCheck, A.ScuessCheck, A.ReqTime,
    A.JudgmentTime, A.Content,A.ToPlayerComment,A.toMakerComment,A.StarPoint,B.NickName,B.ProfilePicktureUrl,B.UserLevel,C.Confirm
    FROM FcubeQuestSuccess A LEFT JOIN UserInfo B ON A.FromUid = B.Uid LEFT JOIN FcubeQuestSuccessCheck C
	 ON A.Cubeuuid = C.Cubeuuid  AND A.Uid = C.Uid AND A.FromUid = C.FromUid AND C.ReadUid = #{readuid}
	 WHERE A.Cubeuuid = #{cubeuuid} AND C.Confirm IS NULL
  </select>
</mapper>